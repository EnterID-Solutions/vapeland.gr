!function(g){var l="undefined"==typeof imageManagerTitle;g("#image,#input-image").closest("tr,.form-group").remove();var o,s=pimJson,r=[480,720,1080,2048,4096,8400,10240,"original"],f=!0,i=[],t=g("#file-input"),e=g("#drop-files p"),m="#list-view",v=!1,w=y("images_path"),b=0;function y(e,t){if(void 0!==t&&void 0!==s[e]){if(void 0!==s[e][t])return s[e][t]}else if(void 0!==s[e])return s[e];return t||e}function d(){if(!((o=g(m+" .image").length)<y("content","max_images")))return g("#drop-files p").html(y("lang","u_up_max")+" "+y("content","max_images")+" "+y("lang","images")+"!").css("color","#fd8b8b"),!0;e.attr("style")&&e.html(y("lang","dad_an_image")).attr("style","")}function _(e,t){var a="";if(e=e.replace(/(\#|\%|\&| )/g,"-"),"default"===t){var i=175-e.length;return a=i<0?e.slice(0,i):e}var n=y("content","translit_map");if("random"===t){for(var o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=0;s<e.length+25&&!(175<s);s++)a+=o.charAt(Math.floor(Math.random()*o.length));return a}if(/[^\u0000-\u007f]/.test(e)&&/\{.\}/.test(n)){for(s=0;s<e.length&&!(175<s);s++){if("~!@$^()_-+={}][".indexOf(e[s])<0)var r=new RegExp("(\\w+)\\{(\\p{L}|\\d)*"+e[s]+"(\\p{L}|\\d)*\\}","ui");(matches=n.match(r))?a+=matches[1]:/[\w-()]/.test(e[s])?a+=e[s]:a+="-"}return delete matches,a}return e}function k(e,t,a,i,n,o,s){if(void 0===o&&(o=.99),"original"===t&&.99<=o&&!n)return s;var r=a.width,l=a.height,d=document.createElement("canvas");"original"!==t&&a.height>t&&(r=a.width*t/a.height,l=t),d.width=r,d.height=l;var c=d.getContext("2d");c.drawImage(a,0,0,r,l),/blob:|wm_bg|base64/.test(a.src)&&n&&function(e,t){if(!t||""==t.text||!t.image)return;e.drawWatermark=function(e,t,a,i){i=parseInt(i)/100;var n=this.width/100,o=Math.min((this.width-2*n)/e.width,this.height/e.height)*i;if(e.width*=o,e.height*=o,this.context.globalAlpha=parseInt(a)/100,"center"==t)var s=(this.width-e.width)/2,r=(this.height-e.height)/2;else{if("multiple"==t){for(var l=parseInt(this.width/e.width),d=parseInt(this.height/e.height),c=0;c<=d;c++){r=c*e.height*1.5;for(var m=0;m<=l;m++){s=e.width*m*1.5+(c%2?e.width/2:0);this.context.drawImage(e,s,r,e.width,e.height)}}return}s=/right$/.test(t)?this.width-e.width-n:n,r=/^bottom/.test(t)?this.height-e.height:0}this.context.drawImage(e,s,r,e.width,e.height)};try{t.image.complete?e.drawWatermark(t.image,t.position,t.opacity,t.size):(t.image.onload=function(){e.drawWatermark(t.image,t.position,t.opacity,t.size)},t.image.onerror=function(){return x(" "+y("lang","watermark_not_found"),"danger",g("#watermark > .row")[0]),!1})}catch(e){x(" "+y("lang","watermark_not_found"),"danger",g("#watermark > .row")[0])}}({context:c,width:r,height:l},n);var m="image/"+("jpg"==e?"jpeg":e),u=i?d:d.toDataURL(m,o);if(s&&1.01*s.size<3*u.length/4){var p=d.toDataURL(m,0).length;u=d.toDataURL(m,1-p/s.size)}return u}function n(e){if(0!=e.length&&f&&!(o>=y("content","max_images"))){f=!1;var t=[],a={imageName:y("content","image_name"),quality:(100-y("content","image_quality")+1)%101/100%1||.99,size:r[y("content","image_size")]};v&&o||(v=function(){var e=y("content","upload_folder");e=(e=e.replace(/\{(.*?)\}/g,function(e,t){if("year"===t||"month"===t||"day"===t)return y(t);if("manufacturer"===t){var a=g("[name ^="+t+"]");if(a[1]&&0!=a[1].value)return a[0].value;if(0!=a[0].value&&"SELECT"===a[0].tagName)return a[0].querySelector("option:checked").text}else try{if(val=g("[name ="+t+"]").val())return val.toLowerCase()}catch(e){}return"undefined"})).split("|");for(var t=0;t<e.length;t++){if(!/[^\u0000-\u007f]|undefined/.test(e[t])){e=e[t]?e[t]+"/":"";break}e.length===t+1&&(e="")}return(l?"catalog/":"data/")+e.replace(/(\#|\%|\&| )/g,"-")}(),g(m+">input.img-input").remove());for(var i=0;i<e.length;i++){if(/(\.(jpe?g|png|gif|bmp)$)/i.test(e[i].name||e[i])){var n=g('<div class ="loaderImg image" ><div class="loading"><div></div><span>'+y("lang","loading")+"...</span></div></div>");e[i].src||"string"==typeof e[i]?t.push({imageBlock:n,url:e[i].src||e[i],name:e[i].name||e[i].replace(/.*\//,"")}):(e[i].imageBlock=n,t.push(e[i])),g(m).append(document.createTextNode("\n")),g(m).append(n)}if(d())break}!function n(r,l){if(0==r.length)return void(f=!0);var e=new Image,d=r.shift(),c="new",m=d.imageBlock,t=d.name.split(/\.(?=[^.]*$)/),u=/png|gif/i.test(t[1])?t[1]:"jpg",p=_(t[0],l.imageName)+"."+u,h=v+p;e.onerror=function(e){x('  "'+p+'" - '+y("lang","image_damaged"),"danger"),m.remove(),n(r,l)};e.onload=function(){if("new"==c){var e="on"===y("content","watermark_status")&&y("content","watermark");"random"!==l.imageName&&(o=u,s=m,t=h,g.ajax({url:"index.php?route=catalog/product/imageExist"+y("token"),type:"POST",contentType:"application/x-www-form-urlencoded",data:{name:t},success:function(e){if(0!=e.status){var t=new Image,a=s.find(".img-input").val(),i=document.createElement("div");i.className="aExist";var n='<img src="" class="ui-sortable-handle" ><p class="e_text">'+y("lang","exist")+"</p>";n+='<p class="e_bottom"><button id="keep" type="button" class="btn btn-default keep_both">'+y("lang","keep_both")+"</button>",n+='<button id="rep" type="button" class="btn btn-default">'+y("lang","replace")+"</button>",n+='<button id="skip" type="button" class="btn btn-default">'+y("lang","keep_old")+"</button></p>",i.innerHTML=n,s.append(i),t.onload=function(){g(i).show("fast"),g("img",i).attr("src",k(o,200,this,!1))},t.src=w+a,g("button",i).one("click",function(){g(i).hide("fast"),"skip"==this.id?s.removeData("upl").find(".previewImg").html("<img src='"+k(o,200,t,!1)+"' />"):"keep"==this.id&&(s.data("upl").name=e.newname,s.find(".img-input").val(a.match(/.*\//)+e.newname)),setTimeout(function(){g(i).remove()},200)})}b--}}),b++),m.data("upl",{name:p,type:u,value:k(u,l.size,this,!1,e,l.quality,d)})}var o,s,t,a=k(u,200,this,!1,e,l.quality);m.html("<span class='previewImg'></span>").removeClass("loaderImg").addClass(c),m.find(".previewImg").append("<img src='"+a+"' />");var i='<span  class="btm_img ">';i+='<i class="fa fa-search-plus" data-toggle="tooltip" aria-hidden="true" data-original-title ="'+y("lang","zoom")+'" ></i>',i+='<i class="fa fa-times" data-toggle="tooltip" aria-hidden="true" data-original-title ="'+y("lang","delete")+'" ></i>',i+='<i class="fa fa-del-all fa-flip-horizontal" data-toggle="tooltip" aria-hidden="true" data-original-title ="'+y("lang","delete_all")+'" ></i>',i+="</span>",i+='<input  value="'+h+'" class = "img-input" type="hidden" >',m.append(i),setTimeout(function(){n(r,l)},20)};d.type?(window.URL=window.URL||window.webkitURL,e.src=window.URL.createObjectURL(d)):(e.src=d.url,-1!=d.url.indexOf(w)&&(e.src=d.url,c="old",h=d.url.replace(w,"")))}(t,a)}}g(m).tooltip({selector:".image i",container:"body"}),g.event.props.push("dataTransfer"),g("body").bind({drop:function(){return!1},dragover:function(e){return!1}}),g(function(){var i=!1,n=0,a=0;function o(e){ds=g(document).scrollTop(),ds>=e-n&&0<i||ds<=a&&i<0?i=!1:i&&(g(document).scrollTop(ds+i),setTimeout(o,100))}g(m).sortable({scroll:!1,handle:".previewImg",start:function(e,t){t.item.addClass("mouseScale"),dh=g(document).height(),a=g(m).offset().top-50,n=g(window).height()},sort:function(e,t){g(document).scrollTop();var a=e.pageY-window.pageYOffset;i=n-30<=a?5:a<=30&&-5,o(dh)},deactivate:function(e,t){setTimeout(function(){t.item.removeClass("mouseScale tapScale")},10),i=!1}}),g(m).disableSelection()}),g("body").bind("drop dragover dragleave",function(e){g("#tab-image.active").length&&("dragover"==e.type?(e.preventDefault(),g(this).attr("class","dropHover")):("drop"==e.type&&n(e.dataTransfer.files),g(this).removeAttr("class","dropHover")))}),t.on("change",function(e){n(g(this)[0].files),t.replaceWith(t=t.val("").clone(!0))}),g(document).on("touchstart touchmove touchend touchcancel",m+" .previewImg",function(e){return"touchstart"==e.type?(stra=0,ssd=setTimeout(function(){g(e.target).parent().addClass("tapScale"),g(document).trigger("touchstart"),p(e),stra=1},200)):"touchend"!=e.type&&"touchmove"!=e.type||clearTimeout(ssd),0==stra?void 0:(p(e),void("touchend"==e.type&&g(this).parent().removeClass("tapScale")))}),d();var a,c=[];multipleAddImages=function(e){var t=l?"":"data/";if("object"==typeof e){var a,i=l?e.parent().find("input"):e.find("input"),n=w+t+i.val();l&&i.click(),-1!=(a=g.inArray(n,c))?(c.splice(a,1),l&&e.removeClass("seBor")):y("content","max_images")>c.length&&(c.push(n),l&&e.addClass("seBor"))}else if("other_dir"==e)for(var o=0;o<c.length;o++){var s=g(l?'#modal-image a[href="'+c[o]+'"]':'#modal-image #column-right input[value="'+c[o].replace(w+t,"")+'"]');s.length&&(l?s.addClass("seBor").next().children().prop("checked",!0):s.parent().addClass("selected"))}var r='<button type="button" data-toggle="tooltip" title="" id="multi_add" class="btn btn-success" data-original-title="'+y("lang","mAdd")+'">';r+='<i class="fa fa-check"></i><span>'+c.length+"</span></button>",g("#multi_add").remove(),0<c.length&&g("#modal-image "+(l?"#button-delete":"#refresh")).after(r)},fmHTML=function(e,t){if(e=e.replace(/(\$\(\'#(.*?)delete\'\)\.(bind|on).*?\{)([\s\S]*?\(json(\.|\[')success.+?{)/g,"$1 $('#multi_add').addClass('hidden');$4 $('.pim-fm  #column-right a.selected,.pim-fm input[name^=path]:checked').each(function(e){multipleAddImages($(this));});$('#multi_add').removeClass('hidden');"),l)e=e.replace("$('#modal-image').modal('hide');","");else{var a='<div class="modal-dialog modal-lg im-oc15"><div  class="modal-content">';a+='<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>',e=(a+='<h4 class="modal-title">'+imageManagerTitle+"</h4></div>")+'<div class="modal-body">'+(e=(e=(e=(e=(e=e.replace("$('#column-right a').removeAttr('class');","")).replace("if ($(this).attr('class') == 'selected')","multipleAddImages($(this));if ($(this).attr('class') == 'selected')")).replace("$('#column-right').html(html);","$('#column-right').html(html);multipleAddImages('other_dir');")).replace("$(element).offset();","$(element).position();")).replace(/\<style[\s\S]*?\/style>/g,""))+"</div></div></div>"}return e=t?e:'<div id="modal-image" class="modal pim-fm">'+e+"</div>"},g(document).on("ajaxComplete",function(e,t,a){g(".pim-fm:visible").length&&void 0===a.pimFileManager&&"GET"===a.type&&/filemanager/.test(a.url)&&(g(".pim-fm").html(fmHTML(t.responseText,!0)),multipleAddImages("other_dir"))}),g("#bySer").on("click",function(){var t=g(this);t.prop("disabled",!0);var a=g("i",this);a.attr("class","fa fa-circle-o-notch fa-spin"),c=[],g(".im-oc15").length?(g("#modal-image #column-right a.selected").removeClass("selected"),g("#multi_add").remove(),g(".pim-fm").modal("show"),t.prop("disabled",!1),a.attr("class","fa fa-cloud")):(g("#modal-image").remove(),g.ajax({pimFileManager:!0,url:"index.php?route=common/filemanager"+y("token"),dataType:"html",success:function(e){g("body").append(fmHTML(e)),g("#modal-image").modal("show"),g("#modal-image").on("click","a,#multi_add",function(e){g(this).is(".thumbnail")&&l?(e.preventDefault(),multipleAddImages(g(this))):g(this).is("#multi_add")&&f&&(g("#modal-image").modal("hide"),n(c))}),t.prop("disabled",!1),a.attr("class","fa fa-cloud")}}))}),g("#byUrl").click(function(){g("#url-input span").toggle("fast")}),g("#url-input button").on("click",function(){var e=g("#url-input input").val().replace(/ /g,"").split("#"),i=[];g("#url-input").append("<i></i>");var t=e.length;setTimeout(function(){g("#url-input i")[0]&&(g("#url-input i")[0].style.width=97/t+"%")},200),function t(a){if(!a--)return g("#url-input i").remove(),g("#url-input input").val(""),g("#url-input span").toggle("fast"),void n(i);e[a]?g.ajax({url:"index.php?route=catalog/product/linkToBase64"+y("token"),type:"POST",contentType:"application/x-www-form-urlencoded",data:{urls:e[a]},success:function(e){e=JSON.parse(e),g("#url-input i")[0].style.width=97/a+"%",i.push(e),t(a)}}):t(a)}(t)}),g(m).on("click",".image i.fa-times",function(){var e=g(this).closest(".image"),t=e.find(".img-input").val();f&&(g(".tooltip").length&&g(".tooltip").remove(),e.is(".old")&&""!=t&&1<y("content","remove_images")&&i.push(t),e.hide("fast",function(){this.remove(),d()}))}),g(m).on("mouseover mouseout",".image i.fa-times",function(e){null!==e.target.parentNode.parentNode.nextElementSibling&&("mouseover"===e.type&&e.target.className.indexOf(" show-del-all")<0?a=setTimeout(function(){e.target.className+=" show-del-all"},200):(clearTimeout(a),e.target.className=e.target.className.replace(" show-del-all","")))}),g(m).on("click",".image .fa-del-all",function(){var e=g(this).closest(".image");e.nextAll().find("i.fa-times").click(),e.find("i.fa-times").click()});var u=document.querySelector('a[onclick="$(\'#form\').submit();"],button[type="submit"]');function p(e){var t=e.originalEvent.changedTouches[0],a=document.createEvent("MouseEvent");return a.initMouseEvent({touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup"}[e.type],!0,!0,window,1,t.screenX,t.screenY,t.clientX,t.clientY,!1,!1,!1,!1,0,null),t.target.dispatchEvent(a),e.preventDefault(),!1}u.parentNode.style="position: relative;",u.setAttribute("type",""),u.setAttribute("onclick",""),u.onclick=function(e){g(".modal form").remove(),e.preventDefault(),f&&imagesUpload(!1)},g("#qsave").on("mousedown",function(e){imagesUpload("before")}),g(document).on("ajaxComplete",function(e,t,a){a.url&&/qsave/.test(a.url)&&imagesUpload(!0)}),window.imagesUpload=function(e){if(g(".keep_both").click(),g.each(g(m).children(),function(e,t){var a="<input class = 'img-input' name='"+(0==e?"image":"product_image["+e+"][image]")+"' value='"+g(this).find(".img-input").val()+"'  type='hidden' >";a+=0==e?"":"\n<input name='product_image["+e+"][sort_order]' value='"+e+"' type='hidden' >",g("input",this).remove(),g(this).append(a)}),o||g(m).html('<input name="image" class = "img-input" type="hidden" >'),"before"===e)return!0;0!=b?(g("button[type=submit]").addClass("shkMe").after("<span  class = 'moment' style='text-align:center;position: absolute;background: #ffffff;border: 1px solid #000;padding: 3px;border-radius: 2px;line-height: 1.2;'>One sec.!</span>"),setTimeout(function(){g("button[type=submit]").removeClass("shkMe").next().remove()},500)):(f=!1,function(a){var r={},l=new FormData;if(g(m+" .new").each(function(e,t){var a=g(this).data("upl");if(a&&!r[a.name]&&a.type){if("object"==typeof a.value)var i=a.value;else{for(var n=atob(a.value.split(",")[1]),o=[],s=0;s<n.length;s++)o.push(n.charCodeAt(s));i=new Blob([new Uint8Array(o)],{type:"image/"+a.type})}l.append(e,i,a.name),r[a.name]=!0,r[0]||(r[0]="image")}this.className=this.className.replace("new","old"),g(this).removeData("upl")}),i.length){for(var e=g("[id^=input-description], .old .img-input").map(function(){return this.value.match(new RegExp(w+"(.*?.(jpe?g|png|gif|bmp))","g"))||this.value}),t=0;t<i.length;t++)-1==g.inArray(i[t],e)&&(l.append("dels[value][]",i[t]),r[0]&&"image"!==r[0]||(l.append("dels[id]",y("product_id")),r[0]=r[0]?"image + delete":"delete"));i=[]}l.append("catalog",v),r[0]?g.ajax({async:!0,contentType:!1,data:l,processData:!1,type:"post",url:"index.php?route=catalog/product/uploadNewImage"+y("token"),xhr:function(){var e=g.ajaxSettings.xhr();if(-1<r[0].indexOf("image")){var t=document.createElement("div");t.innerHTML='<div><span>Upload...</span><div class ="upload-view-bg"></div></div>',t.className="upload-view",u.parentNode.appendChild(t);var a=t.getElementsByClassName("upload-view-bg");e.upload.onprogress=function(e){a[0].style.width=parseInt(100.1/e.total*e.loaded)+"%"}}return e},success:function(e){var t=document.querySelector(".upload-view");t&&t.parentNode.removeChild(t),f=!0,a||g("form").submit()}}):(f=!0,a||g("form").submit())}(e))},scaled="transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",g(document).on("mousedown touchstart",function(e){var t,a=g(e.target).closest(".image");if(g(".z-view").parent().css({"z-index":"1",transform:""}).one(scaled,function(e){g(this).css({"z-index":""}),g(this).off(scaled)}),g(".z-view").remove(),g(".image .fa-search-minus",this).removeClass("fa-search-minus"),g(e.target).is(".fa-search-plus")&&"none"==a.css("transform")){g(e.target).addClass("fa-search-minus");var i=w+a.find(".img-input").val();(t=a.data("upl"))&&(i=t.value);var n="",o=2.7*a.width()>g(m).width()?g(m).width()/a.width():2.7,s=a.offset().left-g(m).offset().left,r=g(m).height()-(a.offset().top-g(m).offset().top+a.height());if(a.width()*o*1.5>g(m).width())n="translateX("+(g(m).width()/2-(s+a.width()/2))/o+"px)";else{var l=(g(m).width()/2-(s+a.width()/2))/o*.1,d=(a.width()*o-a.width())/2,c=s+a.width()+d;l=l+a.width()*o>g(m).width()?0:l,s<d?n="translateX("+((d-s)/o+l)+"px)":g(m).width()<c&&(n="translateX(-"+((c-g(m).width())/o-l)+"px)")}r<0&&(n+=" translateY("+(r-4)+"px)"),a.css({"z-index":"2",transform:"scale("+o+") "+n}),a.one(scaled,function(e){g(this).prepend("<img class='z-view' src='"+i+"'>"),g(this).off(scaled)})}});function x(e,t,a){if(g(".alert-msg").remove(),e){var i='<div  class="alert-msg alert alert-'+(t||"success")+' alert-dismissible"><i class="fa fa-check-circle"></i>';i+=e+'<button type="button" class="close" data-dismiss="alert">×</button></div>',"object"==typeof a&&null!=a.parentNode?g(a).after(i):g("#content > .container-fluid,#content > .box").prepend(i)}}function h(n){g.ajax({data:{settings:n},type:"post",url:"index.php?route=catalog/product/productsImageManagerSettings"+y("token"),success:function(e){var t,a,i;(e=JSON.parse(e)).error||"modal.html"!==n?e.success?(t="content",a=e.content,void 0!==i&&void 0!==a&&void 0!==t?void 0!==s[t]&&(s[t][a]=i):void 0!==a&&void 0!==t&&(s[t]=a),T(),x(e.success),g("#im_setting_modal").modal("hide")):e.error&&(x(e.error,"danger"),g("#im_setting_modal").modal("hide")):(g("#im_setting_modal").remove(),window.preViewCanvas=k,g("body").append(e.content),g("#im_setting_modal").modal("show"))}})}function T(){if("on"===y("content","watermark_status")){var e=y("content","watermark");e.image=new Image,e.image.src=e.src,e.image.onerror=function(){x(" "+y("lang","watermark_not_found"),"danger"),e.image=!1}}}g("#pim_settings").click(function(){h("modal.html")}),g(document).on("click","#save_setting",function(e){this.innerHTML='<i class ="fa fa-circle-o-notch fa-spin" ></i>',h(g("#im_setting_modal form").serialize())}),T()}(jQuery);